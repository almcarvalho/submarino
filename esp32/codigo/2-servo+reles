// SUBMARINO ESP32 COM ANTENA (sem relés)
// LEDs + controle de SERVO pelo analógico esquerdo (PS5)
// LED VERMELHO (GPIO 14): status de conexão
// LED VERDE (GPIO 16): aceso se QUALQUER canal do relé estiver ligado; apagado se TODOS estiverem desligados.
// Relés: X/QUADRADO/TRIANGULO/BOLA fazem toggle nos canais 1..4 do SerialRelay

#include <ps5Controller.h>
#include <ESP32Servo.h>
#include <SerialRelay.h>

// LEDs
#define LED_VERMELHO 14
#define LED_VERDE    16

// Servo
#define SERVO_PIN    27
#define SERVO_MIN_US 500
#define SERVO_MAX_US 2500
Servo servo;

// === RELÉS ===
const byte NumModules = 1;
SerialRelay relays(25, 26, NumModules);  // DATA=25, CLOCK=26, 1 módulo 4 canais

// === VARIÁVEIS DE CONTROLE DOS CANAIS ===
bool canal1Ligado = false;
bool canal2Ligado = false;
bool canal3Ligado = false;
bool canal4Ligado = false;

// Atualiza LED verde conforme estado dos relés
void updateLedVerdeFromRelays() {
  bool algumLigado = canal1Ligado || canal2Ligado || canal3Ligado || canal4Ligado;
  digitalWrite(LED_VERDE, algumLigado ? HIGH : LOW);
}

// Aplica o estado atual das variáveis no módulo
void aplicarEstadosNosRelees() {
  relays.SetRelay(1, canal1Ligado ? SERIAL_RELAY_ON : SERIAL_RELAY_OFF, 1);
  relays.SetRelay(2, canal2Ligado ? SERIAL_RELAY_ON : SERIAL_RELAY_OFF, 1);
  relays.SetRelay(3, canal3Ligado ? SERIAL_RELAY_ON : SERIAL_RELAY_OFF, 1);
  relays.SetRelay(4, canal4Ligado ? SERIAL_RELAY_ON : SERIAL_RELAY_OFF, 1);
  updateLedVerdeFromRelays();
}

// === Config do analógico (servo) ===
const int DEADZONE = 10;
const int SERVO_MIN_ANGLE = 0;
const int SERVO_MAX_ANGLE = 180;
int lastAngle = 90;
const int MAX_STEP = 4;

int analogToAngle(int v) {
  if (abs(v) < DEADZONE) v = 0;
  float n = (float)v / 127.0f;
  int angle = (int)(90.0f + n * 90.0f);
  if (angle < SERVO_MIN_ANGLE) angle = SERVO_MIN_ANGLE;
  if (angle > SERVO_MAX_ANGLE) angle = SERVO_MAX_ANGLE;
  return angle;
}
int smoothStep(int current, int target, int maxStep) {
  if (target > current) return min(current + maxStep, target);
  if (target < current) return max(current - maxStep, target);
  return current;
}

// === ESTADOS ANTERIORES (para detectar borda de subida) ===
bool prevX = false, prevS = false, prevT = false, prevC = false;

// Trata botões do PS5 para togglar os relés
void handleRelayButtons() {
  if (!ps5.isConnected()) return;

  bool xNow = ps5.Cross();
  bool sNow = ps5.Square();
  bool tNow = ps5.Triangle();
  bool cNow = ps5.Circle();

  if (xNow && !prevX) {
    canal1Ligado = !canal1Ligado;
    aplicarEstadosNosRelees();
    Serial.println(String("Canal 1 -> ") + (canal1Ligado ? "ON" : "OFF"));
  }
  if (sNow && !prevS) {
    canal2Ligado = !canal2Ligado;
    aplicarEstadosNosRelees();
    Serial.println(String("Canal 2 -> ") + (canal2Ligado ? "ON" : "OFF"));
  }
  if (tNow && !prevT) {
    canal3Ligado = !canal3Ligado;
    aplicarEstadosNosRelees();
    Serial.println(String("Canal 3 -> ") + (canal3Ligado ? "ON" : "OFF"));
  }
  if (cNow && !prevC) {
    canal4Ligado = !canal4Ligado;
    aplicarEstadosNosRelees();
    Serial.println(String("Canal 4 -> ") + (canal4Ligado ? "ON" : "OFF"));
  }

  prevX = xNow;
  prevS = sNow;
  prevT = tNow;
  prevC = cNow;
}

void setup() {
  Serial.begin(9600);

  pinMode(LED_VERMELHO, OUTPUT);
  pinMode(LED_VERDE, OUTPUT);
  digitalWrite(LED_VERMELHO, LOW);
  digitalWrite(LED_VERDE, LOW);

  servo.attach(SERVO_PIN, SERVO_MIN_US, SERVO_MAX_US);
  servo.write(lastAngle);

  // Inicializa relés desligados
  canal1Ligado = canal2Ligado = canal3Ligado = canal4Ligado = false;
  aplicarEstadosNosRelees();

  ps5.begin("58:10:31:bd:52:38");
  Serial.println("Pronto para conectar ao controle PS5...");
}

void loop() {
  if (ps5.isConnected()) {
    digitalWrite(LED_VERMELHO, HIGH);

    int lx = ps5.LStickX();
    int targetAngle = analogToAngle(lx);
    lastAngle = smoothStep(lastAngle, targetAngle, MAX_STEP);
    servo.write(lastAngle);

    handleRelayButtons();

    delay(10);
  } else {
    digitalWrite(LED_VERMELHO, HIGH);
    delay(300);
    digitalWrite(LED_VERMELHO, LOW);
    delay(300);

    prevX = prevS = prevT = prevC = false;

    if (lastAngle != 90) {
      lastAngle = smoothStep(lastAngle, 90, MAX_STEP);
      servo.write(lastAngle);
    }
  }
}
